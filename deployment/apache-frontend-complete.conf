# ============================================
# Frontend Config: sicamdes.semarnet.id
# Copy-paste config ini ke aaPanel
# ============================================

# ============================================
# HTTP (Port 80)
# ============================================
<VirtualHost *:80>
    ServerAdmin webmaster@example.com
    DocumentRoot "/var/www/cctv/frontend/dist"
    ServerName a1894110.sicamdes.semarnet.id
    ServerAlias sicamdes.semarnet.id
    
    #errorDocument 404 /404.html
    IncludeOptional /www/server/panel/vhost/apache/extension/sicamdes.semarnet.id/*.conf
    
    ErrorLog "/www/wwwlogs/sicamdes.semarnet.id-error_log"
    CustomLog "/www/wwwlogs/sicamdes.semarnet.id-access_log" combined
    
    # ===================================
    # Enable Proxy Modules
    # ===================================
    ProxyPreserveHost On
    ProxyRequests Off
    
    # ===================================
    # Backend API Proxy
    # ===================================
    ProxyPass /api http://localhost:3000/api
    ProxyPassReverse /api http://localhost:3000/api
    
    # ===================================
    # HLS Streaming Proxy (via backend for session tracking)
    # IMPORTANT: Proxy to backend (3000), NOT MediaMTX (8888)
    # ===================================
    ProxyPass /hls http://localhost:3000/hls
    ProxyPassReverse /hls http://localhost:3000/hls
    
    # ===================================
    # WebSocket Support
    # ===================================
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:3000/$1" [P,L]
    
    # ===================================
    # DENY FILES
    # ===================================
    <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)$>
        Order allow,deny
        Deny from all
    </Files>
    
    # ===================================
    # React SPA Directory Config
    # ===================================
    <Directory "/var/www/cctv/frontend/dist">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.html
        
        # React Router - redirect all to index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
        
        # Cache static assets
        <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
        
        # Don't cache index.html
        <FilesMatch "index\.html$">
            Header set Cache-Control "no-store, no-cache, must-revalidate"
        </FilesMatch>
        
        # Don't cache service worker
        <FilesMatch "sw\.js$">
            Header set Cache-Control "no-store, no-cache, must-revalidate"
        </FilesMatch>
    </Directory>
    
    # ===================================
    # Security Headers
    # ===================================
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</VirtualHost>

# ============================================
# HTTPS (Port 443)
# ============================================
<VirtualHost *:443>
    ServerAdmin webmaster@example.com
    DocumentRoot "/var/www/cctv/frontend/dist"
    ServerName SSL.sicamdes.semarnet.id
    ServerAlias sicamdes.semarnet.id
    
    #errorDocument 404 /404.html
    IncludeOptional /www/server/panel/vhost/apache/extension/sicamdes.semarnet.id/*.conf
    
    ErrorLog "/www/wwwlogs/sicamdes.semarnet.id-error_log"
    CustomLog "/www/wwwlogs/sicamdes.semarnet.id-access_log" combined
    
    # ===================================
    # SSL Configuration
    # ===================================
    SSLEngine On
    SSLCertificateFile /www/server/panel/vhost/cert/sicamdes.semarnet.id/fullchain.pem
    SSLCertificateKeyFile /www/server/panel/vhost/cert/sicamdes.semarnet.id/privkey.pem
    SSLCipherSuite EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5:ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1
    SSLHonorCipherOrder On
    
    # ===================================
    # Enable Proxy Modules
    # ===================================
    ProxyPreserveHost On
    ProxyRequests Off
    
    # ===================================
    # Backend API Proxy
    # ===================================
    ProxyPass /api http://localhost:3000/api
    ProxyPassReverse /api http://localhost:3000/api
    
    # ===================================
    # HLS Streaming Proxy (via backend for session tracking)
    # IMPORTANT: Proxy to backend (3000), NOT MediaMTX (8888)
    # ===================================
    ProxyPass /hls http://localhost:3000/hls
    ProxyPassReverse /hls http://localhost:3000/hls
    
    # ===================================
    # WebSocket Support
    # ===================================
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:3000/$1" [P,L]
    
    # ===================================
    # DENY FILES
    # ===================================
    <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)$>
        Order allow,deny
        Deny from all
    </Files>
    
    # ===================================
    # React SPA Directory Config
    # ===================================
    <Directory "/var/www/cctv/frontend/dist">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.html
        
        # React Router - redirect all to index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
        
        # Cache static assets
        <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
        
        # Don't cache index.html
        <FilesMatch "index\.html$">
            Header set Cache-Control "no-store, no-cache, must-revalidate"
        </FilesMatch>
        
        # Don't cache service worker
        <FilesMatch "sw\.js$">
            Header set Cache-Control "no-store, no-cache, must-revalidate"
        </FilesMatch>
    </Directory>
    
    # ===================================
    # Security Headers
    # ===================================
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</VirtualHost>
