# RAF NET CCTV - Nginx Configuration
# ===================================
# 
# Architecture:
# - Frontend: cctv.raf.my.id (serves React SPA)
# - Backend API: api-cctv.raf.my.id (Fastify API + HLS/WebRTC proxy)
#
# Stream Flow:
# 1. Frontend requests /hls/camera1/index.m3u8 from api-cctv.raf.my.id
# 2. Nginx proxies to MediaMTX at localhost:8888
# 3. MediaMTX serves the HLS stream
#
# This keeps MediaMTX internal and not exposed to the internet

# Server block for the Frontend Application
server {
    listen 80;
    listen [::]:80;

    server_name cctv.raf.my.id 172.17.11.12;

    root /var/www/rafnet-cctv/frontend/dist;
    index index.html;

    # Serve React SPA
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    access_log /var/log/nginx/rafnet-cctv-frontend.access.log;
    error_log /var/log/nginx/rafnet-cctv-frontend.error.log;
}

# Server block for the Backend API (Reverse Proxy)
server {
    listen 80;
    listen [::]:80;

    server_name api-cctv.raf.my.id;

    # Increase client body size for potential file uploads
    client_max_body_size 10M;

    # ===================================
    # HLS Stream Proxy
    # ===================================
    # Frontend requests: /hls/camera1/index.m3u8
    # Proxied to: localhost:8888/camera1/index.m3u8
    location /hls/ {
        # Remove /hls prefix when proxying
        rewrite ^/hls/(.*)$ /$1 break;
        proxy_pass http://localhost:8888;
        
        # CORS headers for HLS streaming
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Range' always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Range';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        
        # Disable buffering for live streaming
        proxy_buffering off;
        proxy_cache off;
        
        # Timeouts for streaming
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===================================
    # WebRTC Proxy (if needed)
    # ===================================
    location /webrtc/ {
        rewrite ^/webrtc/(.*)$ /$1 break;
        proxy_pass http://localhost:8889;
        
        # WebSocket support for WebRTC signaling
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # CORS
        add_header 'Access-Control-Allow-Origin' '*' always;
    }

    # ===================================
    # Backend API Proxy
    # ===================================
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    access_log /var/log/nginx/rafnet-cctv-backend.access.log;
    error_log /var/log/nginx/rafnet-cctv-backend.error.log;
}
