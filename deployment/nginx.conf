# RAF NET CCTV - Nginx Configuration (RAM MODE)
# ==============================================
# 
# Architecture:
# - Frontend: cctv.raf.my.id (serves React SPA)
# - Backend API: api-cctv.raf.my.id (Fastify API + HLS/WebRTC proxy)
#
# Stream Flow (RAM OPTIMIZED):
# 1. Frontend requests /hls/camera1/index.m3u8 from api-cctv.raf.my.id
# 2. Nginx proxies to MediaMTX at localhost:8888
# 3. MediaMTX serves HLS from /dev/shm (RAM disk - zero disk I/O)
# 4. Nginx caches in /dev/shm/nginx-cache (RAM cache)
#
# This keeps MediaMTX internal and not exposed to the internet
# NOTE: Using port 800 because port 80 is used by aaPanel

# ===================================
# RAM CACHE CONFIGURATION
# ===================================
# CRITICAL: Cache HLS segments in RAM for instant delivery
# - keys_zone: 10MB for cache keys (supports ~80k segments)
# - max_size: 200MB for cached content
# - inactive: Remove cache after 10 minutes of no access
proxy_cache_path /dev/shm/nginx-cache 
    levels=1:2 
    keys_zone=hls_cache:10m 
    max_size=200m 
    inactive=10m 
    use_temp_path=off;

# ===================================
# SECURITY: Block MediaMTX Management API
# ===================================
# CRITICAL: Deny all external access to MediaMTX API (port 9997)
# This prevents unauthorized camera configuration changes
server {
    listen 800;
    listen [::]:800;
    
    # Block any attempt to access MediaMTX API via these domains
    server_name mediamtx.raf.my.id mtx.raf.my.id api.mediamtx.raf.my.id;
    
    location / {
        deny all;
        return 403 "MediaMTX API access forbidden";
    }
    
    access_log /var/log/nginx/mediamtx-blocked.access.log;
    error_log /var/log/nginx/mediamtx-blocked.error.log;
}

# Server block for the Frontend Application
server {
    listen 800;
    listen [::]:800;

    server_name cctv.raf.my.id 172.17.11.12;

    root /var/www/cctv/frontend/dist;
    index index.html;

    # ===================================
    # SECURITY: Block Access to Sensitive Files
    # ===================================
    # CRITICAL: Deny access to .env files
    location ~ /\.env {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to .git directory
    location ~ /\.git {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to backup files
    location ~ \.(bak|backup|old|orig|save|swp|swo|tmp)$ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to config files
    location ~ /(config|configuration)\.(php|js|json|yml|yaml)\.bak$ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to database files
    location ~ \.(sql|db|sqlite|sqlite3)$ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to .htaccess and other Apache configs
    location ~ /\.ht {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to hidden files (except .well-known for SSL)
    location ~ /\. {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to node_modules
    location ~ /node_modules/ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to package files
    location ~ /(package\.json|package-lock\.json|yarn\.lock|composer\.json|composer\.lock)$ {
        deny all;
        return 404;
    }

    # ===================================
    # SECURITY HEADERS
    # ===================================
    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Enable XSS protection
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Permissions policy
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Serve robots.txt and sitemap.xml directly
    location = /robots.txt {
        try_files $uri =404;
        add_header Content-Type text/plain;
    }
    
    location = /sitemap.xml {
        try_files $uri =404;
        add_header Content-Type application/xml;
    }

    # Service Worker - NEVER cache
    location = /sw.js {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
        add_header Service-Worker-Allowed "/";
        try_files $uri =404;
    }

    # ===================================
    # Recording Playback Proxy (MUST be before /api/)
    # ===================================
    # Special handling for video playback with Range Request support
    location /api/recordings/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CRITICAL: Pass Range header for seeking
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # CRITICAL: Disable buffering for video streaming
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        
        # CRITICAL: Allow large responses (video files)
        proxy_max_temp_file_size 0;
        
        # CRITICAL: Increase buffer sizes for large range requests
        proxy_buffer_size 128k;
        proxy_buffers 8 128k;
        proxy_busy_buffers_size 256k;
        
        # Extended timeouts for large video files
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # CRITICAL: Don't limit request body size
        client_max_body_size 0;
    }

    # ===================================
    # Backend API Proxy (from Frontend Domain)
    # ===================================
    # Proxy /api/* requests to backend
    # This allows frontend to call API from same domain
    # CORS headers are handled by Fastify backend
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===================================
    # HLS Stream Proxy (RAM OPTIMIZED)
    # ===================================
    # Frontend requests: /hls/camera1/index.m3u8
    # Proxied to: Backend at localhost:3000/hls/camera1/index.m3u8
    # Backend then proxies to MediaMTX while tracking viewer sessions
    # This enables tracking ALL viewers (frontend, VLC, direct URL access)
    # 
    # RAM OPTIMIZATION:
    # - Caching enabled in RAM (/dev/shm/nginx-cache)
    # - proxy_buffering OFF for instant delivery
    # - proxy_cache_lock ON to prevent thundering herd
    location /hls/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CRITICAL: Disable buffering for instant streaming
        proxy_buffering off;
        
        # CRITICAL: Enable RAM caching
        proxy_cache hls_cache;
        proxy_cache_valid 200 2s;  # Cache for 2s (segment duration)
        proxy_cache_lock on;       # Prevent thundering herd
        proxy_cache_lock_timeout 5s;
        
        # Cache key based on full URI
        proxy_cache_key "$scheme$proxy_host$request_uri";
        
        # Add cache status header (for debugging)
        add_header X-Cache-Status $upstream_cache_status;
        
        # Timeouts for streaming
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Serve React SPA (must be AFTER /api/ and /hls/ locations)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    access_log /var/log/nginx/cctv-frontend.access.log;
    error_log /var/log/nginx/cctv-frontend.error.log;
}

# Server block for the Backend API (Reverse Proxy)
server {
    listen 800;
    listen [::]:800;

    server_name api-cctv.raf.my.id;

    # Increase client body size for potential file uploads
    client_max_body_size 10M;

    # ===================================
    # SECURITY: Block Access to Sensitive Files
    # ===================================
    # CRITICAL: Deny access to .env files
    location ~ /\.env {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to .git directory
    location ~ /\.git {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to backup files
    location ~ \.(bak|backup|old|orig|save|swp|swo|tmp)$ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to config files
    location ~ /(config|configuration)\.(php|js|json|yml|yaml)\.bak$ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to database files
    location ~ \.(sql|db|sqlite|sqlite3)$ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to .htaccess and other Apache configs
    location ~ /\.ht {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to hidden files (except .well-known for SSL)
    location ~ /\. {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to node_modules
    location ~ /node_modules/ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to package files
    location ~ /(package\.json|package-lock\.json|yarn\.lock|composer\.json|composer\.lock)$ {
        deny all;
        return 404;
    }
    
    # CRITICAL: Deny access to source code directories
    location ~ /(src|tests|spec|\.vscode|\.idea)/ {
        deny all;
        return 404;
    }

    # ===================================
    # SECURITY HEADERS
    # ===================================
    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Enable XSS protection
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Permissions policy
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ===================================
    # HLS Stream Proxy (via Backend for Session Tracking)
    # ===================================
    # Frontend requests: /hls/camera1/index.m3u8
    # Proxied to: Backend at localhost:3000/hls/camera1/index.m3u8
    # Backend then proxies to MediaMTX while tracking viewer sessions
    # This enables tracking ALL viewers (frontend, VLC, direct URL access)
    # NOTE: CORS headers are handled by Fastify, don't add them here
    #
    # RAM OPTIMIZATION:
    # - Caching enabled in RAM (/dev/shm/nginx-cache)
    # - proxy_buffering OFF for instant delivery
    # - proxy_cache_lock ON to prevent thundering herd
    location /hls/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CRITICAL: Disable buffering for instant streaming
        proxy_buffering off;
        
        # CRITICAL: Enable RAM caching
        proxy_cache hls_cache;
        proxy_cache_valid 200 2s;  # Cache for 2s (segment duration)
        proxy_cache_lock on;       # Prevent thundering herd
        proxy_cache_lock_timeout 5s;
        
        # Cache key based on full URI
        proxy_cache_key "$scheme$proxy_host$request_uri";
        
        # Add cache status header (for debugging)
        add_header X-Cache-Status $upstream_cache_status;
        
        # Timeouts for streaming
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===================================
    # WebRTC Proxy (if needed)
    # ===================================
    # NOTE: MediaMTX already adds CORS headers
    location /webrtc/ {
        rewrite ^/webrtc/(.*)$ /$1 break;
        proxy_pass http://localhost:8889;
        
        # WebSocket support for WebRTC signaling
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ===================================
    # Recording Playback Proxy (MUST be before /)
    # ===================================
    # Special handling for video playback with Range Request support
    location /api/recordings/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CRITICAL: Pass Range header for seeking
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # CRITICAL: Disable buffering for video streaming
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        
        # CRITICAL: Allow large responses (video files)
        proxy_max_temp_file_size 0;
        
        # CRITICAL: Increase buffer sizes for large range requests
        proxy_buffer_size 128k;
        proxy_buffers 8 128k;
        proxy_busy_buffers_size 256k;
        
        # Extended timeouts for large video files
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # CRITICAL: Don't limit request body size
        client_max_body_size 0;
    }

    # ===================================
    # Backend API Proxy
    # ===================================
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    access_log /var/log/nginx/cctv-backend.access.log;
    error_log /var/log/nginx/cctv-backend.error.log;
}
