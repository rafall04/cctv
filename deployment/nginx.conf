# RAF NET CCTV - Nginx Configuration
# ===================================
# 
# Architecture:
# - Frontend: cctv.raf.my.id (serves React SPA)
# - Backend API: api-cctv.raf.my.id (Fastify API + HLS/WebRTC proxy)
#
# Stream Flow:
# 1. Frontend requests /hls/camera1/index.m3u8 from api-cctv.raf.my.id
# 2. Nginx proxies to MediaMTX at localhost:8888
# 3. MediaMTX serves the HLS stream
#
# This keeps MediaMTX internal and not exposed to the internet
# NOTE: Using port 800 because port 80 is used by aaPanel

# Server block for the Frontend Application
server {
    listen 800;
    listen [::]:800;

    server_name cctv.raf.my.id 172.17.11.12;

    root /var/www/rafnet-cctv/frontend/dist;
    index index.html;

    # Serve robots.txt and sitemap.xml directly
    location = /robots.txt {
        try_files $uri =404;
        add_header Content-Type text/plain;
    }
    
    location = /sitemap.xml {
        try_files $uri =404;
        add_header Content-Type application/xml;
    }

    # Service Worker - NEVER cache
    location = /sw.js {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
        add_header Service-Worker-Allowed "/";
        try_files $uri =404;
    }

    # ===================================
    # Recording Playback Proxy (MUST be before /api/)
    # ===================================
    # Special handling for video playback with Range Request support
    location /api/recordings/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CRITICAL: Pass Range header for seeking
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # CRITICAL: Disable buffering for video streaming
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        
        # CRITICAL: Allow large responses (video files)
        proxy_max_temp_file_size 0;
        
        # CRITICAL: Increase buffer sizes for large range requests
        proxy_buffer_size 128k;
        proxy_buffers 8 128k;
        proxy_busy_buffers_size 256k;
        
        # Extended timeouts for large video files
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # CRITICAL: Don't limit request body size
        client_max_body_size 0;
    }

    # ===================================
    # Backend API Proxy (from Frontend Domain)
    # ===================================
    # Proxy /api/* requests to backend
    # This allows frontend to call API from same domain
    # CORS headers are handled by Fastify backend
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===================================
    # HLS Stream Proxy (from Frontend Domain)
    # ===================================
    # Proxy /hls/* requests to backend for session tracking
    # Backend then proxies to MediaMTX
    location /hls/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for live streaming
        proxy_buffering off;
        proxy_cache off;
        
        # Timeouts for streaming
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Serve React SPA (must be AFTER /api/ and /hls/ locations)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    access_log /var/log/nginx/rafnet-cctv-frontend.access.log;
    error_log /var/log/nginx/rafnet-cctv-frontend.error.log;
}

# Server block for the Backend API (Reverse Proxy)
server {
    listen 800;
    listen [::]:800;

    server_name api-cctv.raf.my.id;

    # Increase client body size for potential file uploads
    client_max_body_size 10M;

    # ===================================
    # HLS Stream Proxy (via Backend for Session Tracking)
    # ===================================
    # Frontend requests: /hls/camera1/index.m3u8
    # Proxied to: Backend at localhost:3000/hls/camera1/index.m3u8
    # Backend then proxies to MediaMTX while tracking viewer sessions
    # This enables tracking ALL viewers (frontend, VLC, direct URL access)
    # NOTE: CORS headers are handled by Fastify, don't add them here
    location /hls/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for live streaming
        proxy_buffering off;
        proxy_cache off;
        
        # Timeouts for streaming
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===================================
    # WebRTC Proxy (if needed)
    # ===================================
    # NOTE: MediaMTX already adds CORS headers
    location /webrtc/ {
        rewrite ^/webrtc/(.*)$ /$1 break;
        proxy_pass http://localhost:8889;
        
        # WebSocket support for WebRTC signaling
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ===================================
    # Recording Playback Proxy (MUST be before /)
    # ===================================
    # Special handling for video playback with Range Request support
    location /api/recordings/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CRITICAL: Pass Range header for seeking
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # CRITICAL: Disable buffering for video streaming
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        
        # CRITICAL: Allow large responses (video files)
        proxy_max_temp_file_size 0;
        
        # CRITICAL: Increase buffer sizes for large range requests
        proxy_buffer_size 128k;
        proxy_buffers 8 128k;
        proxy_busy_buffers_size 256k;
        
        # Extended timeouts for large video files
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # CRITICAL: Don't limit request body size
        client_max_body_size 0;
    }

    # ===================================
    # Backend API Proxy
    # ===================================
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    access_log /var/log/nginx/rafnet-cctv-backend.access.log;
    error_log /var/log/nginx/rafnet-cctv-backend.error.log;
}
