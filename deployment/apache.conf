# RAF NET CCTV - Apache Configuration
# ==============================================
# 
# Architecture:
# - Frontend: sicamdes.semarnet.id (serves React SPA)
# - Backend API: api-sicamdes.semarnet.id (Fastify API + HLS proxy)
#
# Stream Flow:
# 1. Frontend requests /hls/camera1/index.m3u8 from api-sicamdes.semarnet.id
# 2. Apache proxies to Backend at localhost:3000
# 3. Backend proxies to MediaMTX at localhost:8888 (with session tracking)
#
# This keeps MediaMTX internal and not exposed to the internet
# NOTE: Using port 800 because port 80 is used by other websites

# ===================================
# Frontend Server
# ===================================
<VirtualHost *:800>
    ServerName sicamdes.semarnet.id
    ServerAlias sicamdes.semarnet.id
    
    DocumentRoot /var/www/cctv/frontend/dist
    
    # Enable proxy
    ProxyPreserveHost On
    ProxyRequests Off
    
    # ===================================
    # Backend API Proxy
    # ===================================
    ProxyPass /api http://localhost:3000/api
    ProxyPassReverse /api http://localhost:3000/api
    
    # ===================================
    # HLS Streaming Proxy (via backend for session tracking)
    # ===================================
    # IMPORTANT: Proxy to backend (port 3000), NOT MediaMTX (port 8888)!
    # Backend will proxy to MediaMTX while tracking viewer sessions
    ProxyPass /hls http://localhost:3000/hls
    ProxyPassReverse /hls http://localhost:3000/hls
    
    # ===================================
    # WebSocket Support
    # ===================================
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:3000/$1" [P,L]
    
    # ===================================
    # Static Files (React SPA)
    # ===================================
    <Directory /var/www/cctv/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router - redirect all to index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # ===================================
    # Cache Control
    # ===================================
    # Cache static assets
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # Don't cache index.html
    <FilesMatch "index\.html$">
        Header set Cache-Control "no-store, no-cache, must-revalidate"
    </FilesMatch>
    
    # Don't cache service worker
    <FilesMatch "sw\.js$">
        Header set Cache-Control "no-store, no-cache, must-revalidate"
        Header set Service-Worker-Allowed "/"
    </FilesMatch>
    
    # ===================================
    # Security Headers
    # ===================================
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # ===================================
    # Compression
    # ===================================
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
    
    # ===================================
    # Logs
    # ===================================
    ErrorLog /var/log/apache2/cctv-frontend.error.log
    CustomLog /var/log/apache2/cctv-frontend.access.log combined
</VirtualHost>

# ===================================
# Backend API Server
# ===================================
<VirtualHost *:800>
    ServerName api-sicamdes.semarnet.id
    ServerAlias api-sicamdes.semarnet.id
    
    # Enable proxy
    ProxyPreserveHost On
    ProxyRequests Off
    
    # ===================================
    # Backend API Proxy
    # ===================================
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # ===================================
    # HLS Streaming Proxy (via backend for session tracking)
    # ===================================
    ProxyPass /hls http://localhost:3000/hls
    ProxyPassReverse /hls http://localhost:3000/hls
    
    # ===================================
    # WebSocket Support
    # ===================================
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:3000/$1" [P,L]
    
    # ===================================
    # Security Headers
    # ===================================
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS headers (handled by backend, but add as fallback)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key, X-CSRF-Token"
    
    # ===================================
    # Logs
    # ===================================
    ErrorLog /var/log/apache2/cctv-backend.error.log
    CustomLog /var/log/apache2/cctv-backend.access.log combined
</VirtualHost>
